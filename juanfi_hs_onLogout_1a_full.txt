# juanfi_hs_onLogout_2a_full
# by: Chloe Renae & Edmar Lozada
# ------------------------------

# session timeout = limit-uptime reached
# traffic limit reached = limit-bytes reached
if (($cause="session timeout") or ($cause="traffic limit reached")) do={
  local eReplace do={
    local iRet
    for i from=0 to=([len $1]-1) do={
      local x [pick $1 $i]
      if ($x = $2) do={set x $3}
      set iRet ($iRet . $x)
    }; return $iRet
  }
  local iDInt $interface
  local iDMac $"mac-address"
  local iFHotspot [/ip hotspot profile get [.. get [find interface=$iDInt] profile] html-directory]
  local iFileName [$eReplace $iDMac ":" ""]
  if ($cause~"session timeout") do={ log warning "( $user ) =====[ EXPIRE USER (Time Limit) ]=====" }
  if ($cause~"fic limit reach") do={ log warning "( $user ) =====[ EXPIRE USER (Data Limit) ]=====" }
  /ip hotspot active remove [find user=$username]
  /ip hotspot cookie remove [find user=$username]
  /ip hotspot cookie remove [find mac-address=$iDMac]
  /ip hotspot user   remove [find name=$username]
  if ([/system scheduler find name=$user]!="") do={/system scheduler  remove [find name=$user]
  } else={ log error "( $user ) ONLOGOUT ERROR! /system scheduler remove $user => MISSING!" }
  if ([/file find name="$iFHotspot/data/$iFileName.txt"]!="") do={/file remove "$iFHotspot/data/$iFileName.txt"
  } else={log error "( $user ) ONLOGOUT ERROR! /file remove $iFHotspot/data/$iFileName.txt => MISSING!"}

}
